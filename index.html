<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad Diaria - Envases Universales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- D3.js CDN para la gráfica -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Colores personalizados */
        :root {
            --color-primary: #B02C2E; /* Rojo principal */
            --color-secondary: #808080; /* Gris secundario */
            --color-primary-light: rgba(176, 44, 46, 0.1); /* Sombra tenue del principal */
            --color-secondary-light: rgba(128, 128, 128, 0.1); /* Sombra tenue del secundario */
            --color-primary-dark: #8c2325; /* Tono más oscuro del principal para hover */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #fef2f2, #fde0e0); /* Degradado suave */
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* Para que el mensaje quede abajo */
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
        }

        .card-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* Más redondeado */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            max-width: 480px; /* Ancho máximo para el contenedor */
            width: 100%;
            text-align: center;
            margin: auto; /* Centrar horizontalmente */
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Más redondeado */
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-primary-dark);
        }

        .btn-primary:disabled {
            background-color: var(--color-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-duration {
            background-color: var(--color-secondary-light);
            color: var(--color-secondary);
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem; /* Más redondeado */
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid var(--color-secondary-light);
        }

        .btn-duration.selected,
        .btn-duration:hover {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .message-box.show {
            opacity: 1;
        }

        .message-box.error {
            background-color: #f44336; /* Red */
        }

        /* Animaciones */
        @keyframes fade-in-down {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-down {
            animation: fade-in-down 0.5s ease-out forwards;
        }

        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        .animate-pulse-once {
            animation: pulse-once 0.5s ease-out;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--color-primary-light);
            border-radius: 0.75rem;
            font-weight: 600;
            color: var(--color-primary);
        }

        .leaderboard-item.current-user {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .leaderboard-item span:first-child {
            font-size: 1.125rem; /* text-lg */
        }

        .leaderboard-item span:last-child {
            font-size: 1rem; /* text-base */
        }

        /* Estilos para la gráfica */
        .chart-container {
            background-color: #f8f8f8;
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
            border: 1px solid #e0e0e0;
        }
        .chart-container .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 1rem;
            text-align: center;
        }
        .chart-container svg {
            display: block;
            margin: auto;
        }
        .axis text {
            font-size: 0.75rem;
            fill: #666;
        }
        .axis line, .axis path {
            stroke: #ccc;
            stroke-width: 1;
        }
        .line {
            fill: none;
            stroke: var(--color-primary);
            stroke-width: 2;
        }
        .dot {
            fill: var(--color-primary);
            stroke: white;
            stroke-width: 1.5;
        }
        .dot.empty {
            fill: #ccc; /* Color para puntos vacíos */
        }
        .imc-label {
            font-size: 0.7rem; /* Tamaño de la etiqueta del IMC */
            fill: #333; /* Color del texto */
            text-anchor: middle; /* Centrar el texto en el punto */
            pointer-events: none; /* Para que no interfiera con eventos del punto */
        }
        .reference-line {
            stroke: #22c55e; /* green-500 */
            stroke-width: 2;
            stroke-dasharray: 5 5; /* Línea punteada */
        }
        .reference-label {
            fill: #16a34a; /* green-700 */
            font-size: 0.7rem;
            text-anchor: start;
        }
    </style>
</head>
<body>
    <div id="message-box" class="message-box"></div>

    <div class="card-container">
        <div class="mb-6">
            <h1 class="text-4xl font-extrabold text-[var(--color-primary)] mb-1">ENVASES UNIVERSALES</h1>
            <h2 class="text-2xl font-bold text-[var(--color-primary)] mb-2">Planta León</h2>
            <p class="text-xl font-semibold text-[var(--color-secondary)]">Salud Ocupacional</p>
        </div>

        <p id="current-date" class="text-2xl text-gray-600 mb-2 font-semibold"></p>
        <p id="user-greeting" class="text-xl font-semibold text-[var(--color-primary)] mb-4 animate-fade-in-down"></p>

        <div class="mb-6">
            <label for="user-select" class="block text-gray-700 text-sm font-bold mb-2 text-left">Selecciona tu nombre:</label>
            <select
                id="user-select"
                class="block w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)] bg-gray-50 text-gray-800 text-lg shadow-sm"
                disabled
            >
                <option value="">-- Cargando usuarios --</option>
            </select>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-2">
            <div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-200">
                <p class="text-blue-700 text-sm font-semibold">Pasos Totales</p>
                <p id="total-steps-display" class="text-blue-900 text-2xl font-bold mt-1">0</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg shadow-sm border border-green-200">
                <p class="text-green-700 text-sm font-semibold">Calorías Totales</p>
                <p id="total-calories-display" class="text-green-900 text-2xl font-bold mt-1">0</p>
            </div>
        </div>
        <div class="w-full bg-gray-100 p-2 rounded-lg shadow-sm border border-gray-200 mb-6">
            <p class="text-gray-700 text-sm font-semibold">Último Registro:</p>
            <p id="current-user-last-record-date" class="text-gray-900 text-lg font-bold mt-1">N/A</p>
        </div>

        <!-- Nueva sección para la gráfica de IMC -->
        <div id="imc-chart-section" class="chart-container hidden">
            <div class="chart-title">Historial de IMC</div>
            <div id="imc-chart"></div>
            <p id="imc-chart-message" class="text-center text-gray-600 text-sm mt-2"></p>
        </div>
        <!-- Fin de la nueva sección para la gráfica -->

        <h2 class="text-2xl font-bold text-[var(--color-primary)] mb-4 text-center">¡A Mover el Esqueleto! Registra tu Actividad Diaria</h2>

        <div class="mb-4 text-left">
            <label for="manual-steps" class="block text-gray-700 text-sm font-bold mb-2">Pasos registrados (Registrados en tu celular):</label>
            <input
                type="number"
                id="manual-steps"
                class="block w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)] bg-gray-50 text-gray-800 text-lg shadow-sm"
                placeholder="Ej. 5000"
                min="0"
            />
        </div>

        <div class="mb-4 text-left">
            <label for="screenshot-upload" class="block text-gray-700 text-sm font-bold mb-2">Sube una captura de pantalla (opcional):</label>
            <input
                type="file"
                id="screenshot-upload"
                accept="image/*"
                class="block w-full text-gray-800 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[var(--color-primary)] file:text-white hover:file:bg-[var(--color-primary-dark)]"
            />
            <div id="screenshot-preview-container" class="mt-2 hidden">
                <p class="text-sm text-gray-600 mb-1">Vista previa:</p>
                <img id="screenshot-preview" src="#" alt="Vista previa de la captura de pantalla" class="max-w-full h-auto rounded-lg shadow-md border border-gray-200"/>
            </div>
        </div>

        <div class="mb-4 text-left">
            <label for="activity-select" class="block text-gray-700 text-sm font-bold mb-2">Selecciona tu actividad:</label>
            <select
                id="activity-select"
                class="block w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-[var(--color-primary)] focus:ring-[var(--color-primary)] bg-gray-50 text-gray-800 text-lg shadow-sm"
            >
                <option value="">-- Selecciona una actividad --</option>
                </select>
        </div>

        <div class="w-full flex justify-around mt-4 mb-6 space-x-2">
            <button data-duration="15" class="btn-duration">15 min</button>
            <button data-duration="30" class="btn-duration">30 min</button>
            <button data-duration="45" class="btn-duration">45 min</button>
            <button data-duration="60" class="btn-duration">60 min</button>
        </div>

        <button
            id="submit-button"
            class="w-full btn-primary"
            disabled
        >
            Registrar Actividad Diaria
        </button>

        <div class="leaderboard-section mt-8">
            <h2 class="text-2xl font-bold text-[var(--color-primary)] mb-4 text-center">
                Tablero de Clasificación
            </h2>
            <ul id="leaderboard-list" class="space-y-3">
                </ul>
            <p id="current-user-leaderboard-position" class="text-md text-gray-600 mt-4 text-center"></p>
        </div>
    </div>

    <p class="text-xs text-gray-500 mt-4 text-center max-w-md">
        Los cálculos de calorías y pasos se basan en estimaciones promedio derivadas de investigaciones en ciencia del ejercicio y salud pública, como las proporcionadas por el Compendio de Actividades Físicas (ACSM) y organizaciones de salud reconocidas. Es importante recordar que el gasto calórico individual puede variar según el metabolismo, la intensidad y el peso corporal.
    </p>

    <script type="module">
        // URL de tu Google Apps Script desplegado como aplicación web
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyTQWw1KY_QTh-6_3tAY_w7TKv1LkzGDuCOxFX05_0K5j6ytRyfqkiulBOUIWxGuPzrwg/exec'; 

        // Variables globales para la aplicación
        let userName = null;
        let selectedActivity = null;
        let selectedDuration = null;
        let uploadedImageBase64 = null;
        let hasSubmittedToday = false;
        let leaderboard = []; // Almacena los datos de la tabla de clasificación

        // *** VARIABLE PARA EL LÍMITE DE PASOS ***
        const MAX_MANUAL_STEPS = 15000; // Puedes cambiar este valor según sea necesario

        // Constantes para la conversión de pasos a calorías
        const AVERAGE_STEP_LENGTH_METERS = 0.75; // Longitud promedio de una zancada en metros
        const AVERAGE_WALKING_SPEED_KMPH = 5; // Velocidad promedio de caminata en km/h
        const AVERAGE_WALKING_SPEED_METERS_PER_MIN = (AVERAGE_WALKING_SPEED_KMPH * 1000) / 60; // Convertir a metros/min

        // Obtener elementos del DOM
        const userSelect = document.getElementById('user-select');
        const currentDateElem = document.getElementById('current-date');
        const userGreetingElem = document.getElementById('user-greeting');
        const totalStepsDisplay = document.getElementById('total-steps-display');
        const totalCaloriesDisplay = document.getElementById('total-calories-display');
        const currentUserLastRecordDateElem = document.getElementById('current-user-last-record-date'); // Nuevo elemento
        const manualStepsInput = document.getElementById('manual-steps');
        const screenshotUploadInput = document.getElementById('screenshot-upload');
        const screenshotPreview = document.getElementById('screenshot-preview');
        const screenshotPreviewContainer = document.getElementById('screenshot-preview-container');
        const activitySelect = document.getElementById('activity-select');
        const durationButtons = document.querySelectorAll('.btn-duration');
        const submitButton = document.getElementById('submit-button');
        const leaderboardList = document.getElementById('leaderboard-list');
        const currentUserLeaderboardPosition = document.getElementById('current-user-leaderboard-position');
        const messageBox = document.getElementById('message-box');
        const imcChartSection = document.getElementById('imc-chart-section'); // Contenedor de la gráfica
        const imcChartDiv = document.getElementById('imc-chart'); // Div donde se renderizará la gráfica
        const imcChartMessage = document.getElementById('imc-chart-message'); // Mensaje para la gráfica

        // Actividades comunes
        const commonActivities = [
            { name: 'Fútbol', stepsPerMin: 150, caloriesPerMin: 12 },
            { name: 'Ciclismo', stepsPerMin: 0, caloriesPerMin: 7 },
            { name: 'Caminar', stepsPerMin: 100, caloriesPerMin: 4 }, // Usaremos este valor para la conversión de pasos
            { name: 'Correr', stepsPerMin: 180, caloriesPerMin: 10 },
            { name: 'Natación', stepsPerMin: 0, caloriesPerMin: 8 },
            { name: 'Box', stepsPerMin: 120, caloriesPerMin: 11 },
            { name: 'Levantamiento de Pesas', stepsPerMin: 20, caloriesPerMin: 6 },
            { name: 'Saltar la cuerda', stepsPerMin: 200, caloriesPerMin: 15 }, 
            { name: 'Gimnasio', stepsPerMin: 50, caloriesPerMin: 8 }, 
            { name: 'Otra actividad', stepsPerMin: 0, caloriesPerMin: 0 } 
        ];

        /**
         * Muestra un mensaje temporal al usuario.
         * @param {string} msg - El mensaje a mostrar.
         * @param {boolean} isError - Si el mensaje es un error.
         */
        function showMessage(msg, isError = false) {
            messageBox.textContent = msg;
            messageBox.className = 'message-box show';
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.remove('error');
            }
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Ocultar después de 3 segundos
        }

        /**
         * Obtiene la fecha actual en formato YYYY-MM-DD para la zona horaria de CDMX.
         * @returns {string} La fecha actual en la zona horaria de CDMX.
         */
        function getTodayDateString() {
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: 'America/Mexico_City' // Zona horaria de CDMX/GDL
            };
            // Usamos 'en-CA' para asegurar el formato YYYY-MM-DD
            const date = new Date();
            const formattedDate = date.toLocaleDateString('en-CA', options);
            console.log(`Frontend: Fecha actual (America/Mexico_City): ${formattedDate}`);
            return formattedDate;
        }

        /**
         * Calcula los pasos y calorías basados en la actividad, duración y pasos manuales.
         * Ahora incluye la conversión de pasos manuales a calorías.
         * @param {number} manualSteps - Pasos registrados manualmente.
         * @returns {{steps: number, calories: number}} Objeto con pasos y calorías calculados.
         */
        function calculateActivityData(manualSteps) {
            let totalSteps = 0;
            let totalCalories = 0;

            // 1. Calcular calorías y pasos de la actividad principal (si seleccionada)
            if (selectedActivity && selectedDuration) {
                const activity = commonActivities.find(act => act.name === selectedActivity);
                if (activity) {
                    totalSteps += activity.stepsPerMin * selectedDuration;
                    totalCalories += activity.caloriesPerMin * selectedDuration;
                }
            }

            // 2. Convertir pasos manuales a calorías y sumarlos
            if (manualSteps > 0) {
                // Sumar los pasos manuales a los pasos totales
                totalSteps += manualSteps;

                // Calcular la distancia a partir de los pasos manuales
                const distanceInMeters = manualSteps * AVERAGE_STEP_LENGTH_METERS;

                // Calcular el tiempo estimado de caminata para esta distancia
                // Tiempo (minutos) = Distancia (metros) / Velocidad (metros/min)
                const estimatedWalkingTimeMinutes = distanceInMeters / AVERAGE_WALKING_SPEED_METERS_PER_MIN;

                // Obtener las calorías por minuto para la actividad "Caminar"
                const walkingActivity = commonActivities.find(act => act.name === 'Caminar');
                const caloriesPerMinForWalking = walkingActivity ? walkingActivity.caloriesPerMin : 4; // Valor por defecto si no se encuentra

                // Calcular las calorías de los pasos manuales
                const caloriesFromManualSteps = estimatedWalkingTimeMinutes * caloriesPerMinForWalking;

                // Sumar estas calorías al total
                totalCalories += caloriesFromManualSteps;
            }

            return { steps: totalSteps, calories: totalCalories };
        }

        /**
         * Actualiza el estado del botón de envío.
         */
        function updateSubmitButtonState() {
            const manualSteps = parseInt(manualStepsInput.value) || 0;
            const isFormComplete = userName && selectedActivity && selectedDuration && manualSteps > 0 && manualSteps <= MAX_MANUAL_STEPS;
            
            if (hasSubmittedToday) {
                submitButton.disabled = true;
                submitButton.textContent = 'Actividad Diaria Registrada (Vuelve mañana)';
            } else {
                submitButton.disabled = !isFormComplete;
                submitButton.textContent = 'Registrar Actividad Diaria';
            }
        }

        /**
         * Carga y muestra los datos del usuario actual (pasos y calorías totales) desde GAS.
         * Ahora también carga y grafica los datos de IMC.
         */
        async function loadUserNameData() {
            if (!userName) {
                // Resetear si no hay usuario seleccionado
                totalStepsDisplay.textContent = '0';
                totalCaloriesDisplay.textContent = '0';
                currentUserLastRecordDateElem.textContent = 'N/A'; // Resetear la fecha de último registro
                hasSubmittedToday = false;
                updateSubmitButtonState();
                imcChartSection.classList.add('hidden'); // Ocultar gráfica si no hay usuario
                imcChartMessage.textContent = ''; // Limpiar mensaje
                return;
            }

            try {
                console.log(`loadUserNameData: Fetching totals for user: ${userName} from ${GAS_WEB_APP_URL}`);
                const response = await fetch(GAS_WEB_APP_URL + '?command=getTotals&userName=' + encodeURIComponent(userName));
                const data = await response.json();
                console.log('loadUserNameData: Totals data received:', data);

                if (data.success) {
                    totalStepsDisplay.textContent = data.totalSteps ? data.totalSteps.toLocaleString() : '0';
                    totalCaloriesDisplay.textContent = data.totalCalories ? Math.round(data.totalCalories).toLocaleString() : '0'; // Redondear calorías

                    const todayDateFrontend = getTodayDateString(); // Fecha actual en frontend (CDMX)
                    let gasLastSubmissionDate = data.lastSubmissionDate; // Fecha de último registro desde GAS (debería estar en la TZ del script)

                    // *** LOGS DE DEPURACIÓN ADICIONALES ***
                    console.log(`loadUserNameData: Fecha de último registro desde GAS (Script TZ): ${gasLastSubmissionDate}`);
                    console.log(`loadUserNameData: Fecha actual en Frontend (CDMX): ${todayDateFrontend}`);
                    console.log(`loadUserNameData: ¿Son iguales las fechas? ${gasLastSubmissionDate === todayDateFrontend}`);
                    console.log(`loadUserNameData: IMC data received from GAS:`, data.imcData); // <-- NUEVO LOG
                    // *************************************

                    hasSubmittedToday = gasLastSubmissionDate === todayDateFrontend;
                    currentUserLastRecordDateElem.textContent = gasLastSubmissionDate || 'N/A'; // Actualizar el elemento de la última fecha de registro
                    
                    // Renderizar la gráfica de IMC
                    if (data.imcData && Array.isArray(data.imcData)) {
                        renderIMCChart(data.imcData);
                    } else {
                        imcChartSection.classList.add('hidden'); // Ocultar si no hay datos de IMC
                        imcChartMessage.textContent = 'No hay datos de IMC para mostrar la gráfica.'; // Mensaje si no hay datos
                    }

                } else {
                    totalStepsDisplay.textContent = '0';
                    totalCaloriesDisplay.textContent = '0';
                    currentUserLastRecordDateElem.textContent = 'N/A'; // Resetear si hay error
                    hasSubmittedToday = false;
                    imcChartSection.classList.add('hidden'); // Ocultar gráfica si hay error
                    imcChartMessage.textContent = 'Error al cargar datos de IMC.'; // Mensaje si hay error
                    console.error("Error al cargar datos del usuario desde GAS:", data.error);
                    showMessage("Error al cargar datos del usuario.", true);
                }
            } catch (error) {
                console.error("Error de red al cargar datos del usuario:", error);
                showMessage("Error de conexión al cargar datos del usuario.", true);
                imcChartSection.classList.add('hidden'); // Ocultar gráfica si hay error de red
                imcChartMessage.textContent = 'Error de conexión al cargar datos de IMC.'; // Mensaje si hay error de red
            }
            updateSubmitButtonState(); // Actualizar el estado del botón después de cargar los datos
        }

        /**
         * Obtiene los datos de la tabla de clasificación desde GAS.
         */
        async function fetchLeaderboardData() {
            try {
                console.log(`fetchLeaderboardData: Fetching leaderboard from ${GAS_WEB_APP_URL}`);
                const response = await fetch(GAS_WEB_APP_URL + '?command=getLeaderboard');
                const data = await response.json();
                console.log('fetchLeaderboardData: Leaderboard data received:', data);

                if (data.success) {
                    leaderboard = data.leaderboard; // Asume que GAS devuelve la lista ya ordenada
                } else {
                    console.error("Error al obtener la tabla de clasificación desde GAS:", data.error);
                    showMessage("Error al cargar la tabla de clasificación.", true);
                    leaderboard = [];
                }
            } catch (error) {
                console.error("Error de red al obtener la tabla de clasificación:", error);
                showMessage("Error de conexión al cargar la tabla de clasificación.", true);
                leaderboard = [];
            }
            updateLeaderboardUI();
        }

        /**
         * Actualiza la interfaz de usuario de la tabla de clasificación.
         */
        function updateLeaderboardUI() {
            leaderboardList.innerHTML = '';
            currentUserLeaderboardPosition.textContent = '';

            // Mostrar solo los primeros 3 lugares
            // Ordenar por Calorías Totales de forma descendente
            const sortedLeaderboard = [...leaderboard].sort((a, b) => (b.CaloriasTotales || 0) - (a.CaloriasTotales || 0));
            const top3 = sortedLeaderboard.slice(0, 3);

            if (top3.length === 0) {
                leaderboardList.innerHTML = '<li class="text-gray-500 text-center">Nadie ha registrado actividad aún. ¡Sé el primero!</li>';
            } else {
                top3.forEach((user, index) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'leaderboard-item';
                    listItem.innerHTML = `
                        <span>${index + 1}. ${user.NombreParticipante}</span>
                        <span>${Math.round(user.CaloriasTotales || 0).toLocaleString()} calorías</span>
                    `;
                    leaderboardList.appendChild(listItem);
                });
            }

            // Mostrar la posición del usuario actual (basado en calorías)
            if (userName) {
                const userIndex = sortedLeaderboard.findIndex(u => u.NombreParticipante === userName);
                if (userIndex !== -1) {
                    const userPosition = userIndex + 1;
                    const userTotalCalories = Math.round(sortedLeaderboard[userIndex].CaloriasTotales || 0).toLocaleString();
                    currentUserLeaderboardPosition.textContent = `Estás en la posición ${userPosition} con ${userTotalCalories} calorías.`;
                } else {
                    currentUserLeaderboardPosition.textContent = `Aún no apareces en la tabla de clasificación. ¡Registra tu actividad!`;
                }
            }
        }

        /**
         * Dibuja la gráfica de puntos de IMC.
         * @param {Array<number|null>} imcData - Un array de 4 valores de IMC (null si no hay dato).
         */
        function renderIMCChart(imcData) {
            imcChartDiv.innerHTML = ''; // Limpiar cualquier gráfica anterior
            imcChartMessage.textContent = ''; // Limpiar mensajes anteriores
            imcChartSection.classList.remove('hidden'); // Mostrar la sección de la gráfica

            console.log(`renderIMCChart: Raw imcData received:`, imcData); // <-- LOG

            const validData = imcData.map((d, i) => ({
                index: i + 1, // Para el eje X (1, 2, 3, 4)
                value: typeof d === 'number' && !isNaN(d) && d > 0 ? d : null // Solo valores numéricos y > 0
            })).filter(d => d.value !== null); // Filtrar puntos nulos

            console.log(`renderIMCChart: Filtered validData:`, validData); // <-- LOG

            if (validData.length === 0) {
                imcChartDiv.innerHTML = '';
                imcChartMessage.textContent = 'No hay datos de IMC válidos para mostrar la gráfica.';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 40, left: 40 };
            const width = 400 - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;

            const svg = d3.select(imcChartDiv)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Escala X (para 4 puntos de datos)
            const x = d3.scalePoint()
                .domain(d3.range(1, 5).map(String)) // Dominios "1", "2", "3", "4"
                .range([0, width])
                .padding(0.5); // Espacio entre puntos

            // Eje X
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .attr("class", "axis x-axis");

            // Escala Y (del 15 al 45, brincos de 5 en 5)
            const y = d3.scaleLinear()
                .domain([15, 45]) // Dominio de 15 a 45
                .range([height, 0]);

            // Eje Y
            svg.append("g")
                .call(d3.axisLeft(y).ticks(Math.round((45 - 15) / 5))) // Ticks cada 5 unidades
                .attr("class", "axis y-axis");

            // Línea que une los puntos
            const line = d3.line()
                .x(d => x(String(d.index)))
                .y(d => y(d.value))
                .defined(d => d.value !== null); // Solo dibuja la línea si el valor no es nulo

            svg.append("path")
                .datum(validData)
                .attr("class", "line")
                .attr("d", line);

            // Puntos de datos
            svg.selectAll(".dot")
                .data(validData)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", d => x(String(d.index)))
                .attr("cy", d => y(d.value))
                .attr("r", 5); // Radio del punto
            
            // Mostrar el valor del IMC al lado de cada punto
            svg.selectAll(".imc-label")
                .data(validData)
                .enter().append("text")
                .attr("class", "imc-label")
                .attr("x", d => x(String(d.index)))
                .attr("y", d => y(d.value) - 10) // Un poco por encima del punto
                .text(d => d.value.toFixed(2)); // Mostrar con 2 decimales

            // --- Líneas de referencia para IMC normal ---
            const normalIMCLower = 18.5;
            const normalIMCUpper = 24.9;

            // Línea de IMC Normal (Límite Inferior)
            svg.append("line")
                .attr("class", "reference-line")
                .attr("x1", 0)
                .attr("y1", y(normalIMCLower))
                .attr("x2", width)
                .attr("y2", y(normalIMCLower));

            // Línea de IMC Normal (Límite Superior)
            svg.append("line")
                .attr("class", "reference-line")
                .attr("x1", 0)
                .attr("y1", y(normalIMCUpper))
                .attr("x2", width)
                .attr("y2", y(normalIMCUpper));
            // --- Fin Líneas de referencia ---

            // Mensaje si no hay suficientes datos para una línea
            if (validData.length < 2) {
                imcChartMessage.textContent = 'Se necesitan al menos 2 registros de IMC para dibujar la línea.';
            } else {
                imcChartMessage.textContent = ''; // Limpiar mensaje si hay suficientes datos
            }
        }


        /**
         * Actualiza todos los elementos dinámicos de la interfaz de usuario.
         */
        function updateUI() {
            currentDateElem.textContent = `Fecha: ${getTodayDateString()}`;

            if (userName) {
                userGreetingElem.textContent = `¡Hola, ${userName}!`;
                userGreetingElem.classList.add('animate-fade-in-down'); // Re-aplicar animación
            } else {
                userGreetingElem.textContent = 'Por favor, selecciona tu nombre.';
                totalStepsDisplay.textContent = '0';
                totalCaloriesDisplay.textContent = '0';
                currentUserLastRecordDateElem.textContent = 'N/A'; // Asegurarse de que se resetee
                imcChartSection.classList.add('hidden'); // Ocultar gráfica si no hay usuario
                imcChartMessage.textContent = ''; // Limpiar mensaje
            }
            loadUserNameData(); // Cargar datos específicos del usuario y actualizar el estado del botón
            fetchLeaderboardData(); // Asegurar que la tabla de clasificación se actualice
        }

        // --- Manejadores de Eventos ---

        userSelect.addEventListener('change', (e) => {
            userName = e.target.value;
            // Resetear el formulario al cambiar de usuario
            manualStepsInput.value = '';
            screenshotUploadInput.value = '';
            uploadedImageBase64 = null;
            screenshotPreview.src = '#';
            screenshotPreviewContainer.classList.add('hidden');
            activitySelect.value = '';
            durationButtons.forEach(btn => btn.classList.remove('selected'));
            selectedActivity = null;
            selectedDuration = null;
            hasSubmittedToday = false; // Resetear la bandera para el nuevo usuario
            updateUI();
        });

        activitySelect.addEventListener('change', (e) => {
            selectedActivity = e.target.value;
            updateSubmitButtonState();
        });

        durationButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                durationButtons.forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                selectedDuration = parseInt(e.target.dataset.duration);
                updateSubmitButtonState();
            });
        });

        manualStepsInput.addEventListener('input', () => {
            // Validar que solo sean números y el límite
            let value = manualStepsInput.value;
            if (value === '' || isNaN(value)) {
                manualStepsInput.value = ''; // Limpiar si no es número
                showMessage('¡Ojo! Solo puedes ingresar números en los pasos.', true);
            } else {
                value = parseInt(value);
                if (value > MAX_MANUAL_STEPS) {
                    manualStepsInput.value = MAX_MANUAL_STEPS; // Limitar al máximo
                    showMessage(`¡Wow, campeón! El máximo de pasos para registrar es ${MAX_MANUAL_STEPS.toLocaleString()}.`, true);
                } else if (value < 0) {
                    manualStepsInput.value = 0; // No permitir negativos
                    showMessage('¡Vamos, los pasos no pueden ser negativos!', true);
                }
            }
            updateSubmitButtonState();
        });

        screenshotUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    uploadedImageBase64 = event.target.result; // Base64 string
                    screenshotPreview.src = uploadedImageBase64;
                    screenshotPreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                uploadedImageBase64 = null;
                screenshotPreview.src = '#';
                screenshotPreviewContainer.classList.add('hidden');
            }
        });

        submitButton.addEventListener('click', async () => {
            // **NUEVA VALIDACIÓN AL HACER CLIC EN EL BOTÓN**
            if (hasSubmittedToday) {
                showMessage('¡Alto ahí, superhéroe! Ya dejaste tu huella de pasos y calorías por hoy. ¡A recargar energías para mañana!', true);
                return; // Detener la ejecución si ya se registró hoy
            }

            if (!userName || !selectedActivity || !selectedDuration) {
                showMessage('Por favor, selecciona tu nombre, actividad y duración.', true);
                return;
            }

            const manualSteps = parseInt(manualStepsInput.value) || 0;
            if (manualSteps <= 0) {
                showMessage('Por favor, ingresa un número de pasos válido (mayor que 0).', true);
                return;
            }
            // Validar el límite de pasos también en el submit
            if (manualSteps > MAX_MANUAL_STEPS) {
                 showMessage(`¡Wow, campeón! El máximo de pasos para registrar es ${MAX_MANUAL_STEPS.toLocaleString()}.`, true);
                 return;
            }


            submitButton.disabled = true;
            submitButton.textContent = 'Registrando...';
            submitButton.classList.add('animate-pulse-once');

            try {
                const { steps, calories } = calculateActivityData(manualSteps);
                const todayDate = getTodayDateString(); // Obtener la fecha en CDMX para el envío

                const payload = {
                    command: 'submitDailyRecord',
                    data: JSON.stringify({ // Stringify the data object
                        Fecha: todayDate, // Enviar la fecha en CDMX
                        Nombre: userName, // 'Nombre' para Registros Diarios
                        Participante: userName, // 'Participante' para Totales Concurso
                        Pasos: steps,
                        Calorias: calories,
                        Actividad: selectedActivity,
                        Duracion: selectedDuration,
                        Captura: uploadedImageBase64 // Puede ser null
                    })
                };

                console.log('submitDailyRecord: Sending payload to GAS:', payload);
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // Formato para GAS
                    },
                    body: new URLSearchParams(payload).toString()
                });

                const result = await response.json();
                console.log('submitDailyRecord: Response from GAS:', result);

                if (result.success) {
                    showMessage('¡Actividad registrada con éxito!');
                    hasSubmittedToday = true; // Marcar como enviado para hoy
                    updateUI(); // Refrescar la UI y el estado del botón

                    // Limpiar formulario
                    manualStepsInput.value = '';
                    screenshotUploadInput.value = '';
                    uploadedImageBase64 = null;
                    screenshotPreview.src = '#';
                    screenshotPreviewContainer.classList.add('hidden');
                    activitySelect.value = '';
                    durationButtons.forEach(btn => btn.classList.remove('selected'));
                    selectedActivity = null;
                    selectedDuration = null;
                } else {
                    console.error("Error al registrar la actividad en GAS:", result.error);
                    showMessage(`Error al registrar: ${result.error}`, true);
                }
            } catch (error) {
                console.error("Error de red al registrar la actividad:", error);
                showMessage(`Error de conexión al registrar: ${error.message}`, true);
            } finally {
                submitButton.classList.remove('animate-pulse-once');
                updateSubmitButtonState(); // Asegurar que el botón se actualice incluso con errores
            }
        });

        /**
         * Carga los participantes desde la hoja "Participantes" de Google Sheets.
         */
        async function loadParticipants() {
            try {
                console.log(`loadParticipants: Fetching participants from ${GAS_WEB_APP_URL}`);
                const response = await fetch(GAS_WEB_APP_URL + '?command=getParticipants');
                const data = await response.json();
                console.log('loadParticipants: Participants data received:', data);

                if (data.success && data.participants) {
                    // Ordenar participantes alfabéticamente
                    data.participants.sort((a, b) => a.localeCompare(b));

                    userSelect.innerHTML = '<option value="">-- Selecciona tu nombre --</option>'; // Limpiar y añadir opción por defecto
                    data.participants.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p;
                        option.textContent = p;
                        userSelect.appendChild(option);
                    });
                    userSelect.disabled = false; // Habilitar el selector de usuario
                } else {
                    console.error("Error al cargar participantes desde GAS:", data.error);
                    showMessage("Error al cargar la lista de participantes.", true);
                    userSelect.innerHTML = '<option value="">-- Error al cargar usuarios --</option>';
                }
            } catch (error) {
                console.error("Error de red al cargar participantes:", error);
                showMessage("Error de conexión al cargar participantes.", true);
                userSelect.innerHTML = '<option value="">-- Error de conexión --</option>';
            }
        }

        // --- Inicialización de la Aplicación ---
        window.onload = async () => {
            // Cargar participantes al inicio
            await loadParticipants();

            // Rellenar el selector de actividades y ordenarlas alfabéticamente
            activitySelect.innerHTML = '<option value="">-- Selecciona una actividad --</option>'; // Limpiar opciones existentes
            
            // Ordenar las actividades alfabéticamente por nombre
            commonActivities.sort((a, b) => a.name.localeCompare(b.name));

            commonActivities.forEach(activity => {
                const option = document.createElement('option');
                option.value = activity.name;
                option.textContent = activity.name;
                activitySelect.appendChild(option);
            });

            updateUI(); // Actualizar la UI inicial
        };
    </script>
</body>
</html>
